<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Landing Page</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <h1> {{ current_user.first_name }}'s User Management</h1>

    <!-- Table to Display Items -->
    <h2>Current Users</h2>
    <table id="usersTable">
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>User Type</th>
            <th>Actions</th>
        </tr>
        {% for user in users %}
            {% if user.uin|int != current_user.uin|int %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.first_name }}</td>
                    <td>{{ user.last_name }}</td>
                    <td>
                        <select id= "user_type_{{user.uin}}" name="user_type" data-uin = {{user.uin}} data-usertype = {{user.user_type}} >
                            <option value="k12_student" {% if user.user_type == "k12_student" %} Selected {% endif%}>K-12 Student</option>
                            <option value="college_student"  {% if user.user_type == "college_student" %} Selected {% endif%}>College Student</option>
                            <option value="admin"  {% if user.user_type == "admin" %} Selected {% endif%} >Admin</option>
                        </select>
                    </td>
                    <td>
                        <button onclick="editButtonPress({{ user.uin }})">Edit</button>
                        {% if user.archived %}
                            <button onclick="updateUser('Archived', {{user.uin}}, 0)">Unarchive</button>
                        {% else %}
                            <button onclick="updateUser('Archived', {{user.uin}}, 1)">Archive</button>
                        {% endif %}
                        <button onclick="deleteUser({{user.uin}})">Delete</button>
                    </td>
                </tr>
            {% else %}
            {% endif %}
        {% endfor %}
    </table>

    <!-- Logout Button -->
    <form action="{{ url_for('logout') }}" method="post">
        <button type="submit">Logout</button>
    </form>

    <!-- Edit Profile Button -->
    <form action="{{ url_for('profile') }}" method="get">
        <button type="submit">Edit Profile</button>
    </form>

    <!-- User Type Selector Modal Container -->
    <Modal id="userTypeFrom" style="display:none;">
    </Modal>


    <script>
        //AJAX calls

        // Redirect to editUser page
        function editButtonPress(uin) {
            window.location.href = `/admin/edit/user/${uin}`;
        }

        // Delete User
        function deleteUser(uin) {
            var confirmation = confirm("Are you sure you'd like to delete this user?");
            if (confirmation) {
                $.ajax({
                    url: `/admin/delete_user/${uin}`,
                    method: 'DELETE',
                    success: function(response) {
                        window.location.reload(); 
                    },
                    error: function() {
                        alert('Error: User could not be deleted.');
                    }
                });
            }
        }

        // update user: called for archive
        function updateUser(field, uin, value) {
            $.ajax({
                url: `/admin/update_user/${uin}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    'uin': uin,
                    'field':field,
                    'value': value
                }),
                success: function(response) {
                    window.location.reload();
                }
            });
        }

        $('select[name="user_type"]').change(function() {
            var selectedUserType = $(this).val();
            var uin = $(this).data('uin');

            // Revert any previously changed selectors
            $('select[name="user_type"]').each(function() {
                if ($(this).data('uin') != uin) {
                    $(this).val($(this).data('usertype'));
                }
            });
            
            // store the current user_type (before change)
            var current_user_type; 
            if ($(this).data('usertype') == 'admin'){
                current_user_type = "admin";
            } else if ($(this).data('usertype') == 'college_student'){
                current_user_type = "college_student";
            } else{
                current_user_type = "k12_student";
            }

            // if current type is different from the selected user_type, show form
            if(current_user_type != selectedUserType){
                $.ajax({
                    url: '/admin/user_type_form',
                    method: 'POST',
                    data: { 
                        user_type: selectedUserType,
                        uin: uin
                     },
                    success: function(response) {
                        $('#userTypeFrom').html(response).show();
                    }
                });
            } else{
                $('#userTypeFrom').hide();
            }
        });
    </script>
</body>
</html>
